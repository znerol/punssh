#!/usr/bin/env python3

import argparse
import jinja2
import yaml


def punssh_load(path):
    """
    Loads configuration from yaml file and returns it.
    """
    with open(path) as stream:
        return yaml.safe_load(stream)


def punssh_config(name, config):
    """
    Extracts a tunnel from config and applies the specified config template.
    """
    env = jinja2.Environment(
        loader=jinja2.FileSystemLoader('punssh/templates'),
    )

    for tunnel in config.get("tunnels", []):
        if tunnel["name"] == name:
            tplname = "{:s}.config.j2".format(tunnel["template"])
            template = env.get_template(tplname)
            return template.render(**tunnel)

    raise IndexError("Tunnel not found")


if __name__ == "__main__":
    parser = argparse.ArgumentParser(
            description='prints configuration for the given tunnel to stdout')
    parser.add_argument(
            '-f', help='config file', default="punssh/config.yml")
    parser.add_argument(
            'name', help='name of configuration')
    args = parser.parse_args()
    print(punssh_config(args.name, punssh_load(args.f)))
